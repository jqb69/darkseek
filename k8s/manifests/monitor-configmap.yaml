---
#k8s/manifests/monitor-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mqtt-monitor-script
  namespace: default
åº§data:
  mqtt-testk8s.sh: |
    #!/bin/bash
    log() { echo "[$(date -u +'%Y-%m-%dT%H:%M:%SZ')] $*"; }
    
    check_net() {
      # Proves CNI is working by hitting the Backend WS port
      nc -zv darkseek-backend-ws 8000 >/dev/null 2>&1
    }

    recover() {
      log "ðŸš¨ Connectivity lost. Refreshing NetworkPolicies..."
      kubectl delete netpol --all --ignore-not-found
      # Wait 60s for GKE Autopilot/Calico to re-sync state
      sleep 60 
    }

    log "ðŸš€ Monitor Cycle Start"
    if check_net; then
      log "âœ… Network OK"
    else
      recover
    fi
