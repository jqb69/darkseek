---
# k8s/policies/02-allow-backend-ws.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-ws
  namespace: default
spec:
  # This policy targets the darkseek-backend-ws pod
  podSelector:
    matchLabels:
      app: darkseek-backend-ws
  
  policyTypes:
    - Ingress
    - Egress
    
  # --- INGRESS RULES ---
  ingress:
    # Rule 1: Allow connections from the debug-mqtt pod
    - from:
      - podSelector:
          matchLabels:
            app: debug-mqtt
      ports:
      - protocol: TCP
        port: 8000
      
    # Rule 2: Allow connections from the frontend
    - from:
      - podSelector:
          matchLabels:
            app: darkseek-frontend
      ports:
      - protocol: TCP
        port: 8000
  
  # --- SECURE EGRESS RULES ---
  egress:
    # RULE 1: GKE 2025 DNS RESOLUTION (Verified for Autopilot)
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system
        podSelector:
          matchLabels:
            k8s-app: coredns  # Verified GKE 2025 Label
      ports:
      - protocol: UDP
        port: 53
      - protocol: TCP
        port: 53

    # Rule 2: Allow connection to the internal MQTT Broker
    - to:
      - podSelector:
          matchLabels:
            app: darkseek-backend-mqtt
      ports:
      - protocol: TCP
        port: 8885

    # Rule 3: Allow connection back to the debug-mqtt pod
    - to:
      - podSelector:
          matchLabels:
            app: debug-mqtt
      ports:
      - protocol: TCP
        port: 8000      

    # Rule 4: Allow egress to the Redis cache
    - to:
      - podSelector:
          matchLabels:
            app: darkseek-redis
      ports:
      - protocol: TCP
        port: 6379

    # Rule 5: Allow egress to the PostgreSQL Database
    - to:
      - podSelector:
          matchLabels:
            app: darkseek-db
      ports:
      - protocol: TCP
        port: 5432

    # Rule 6: Allow general Internet access for LLM/Search APIs
    - to:
      - ipBlock:
          cidr: 0.0.0.0/0
          except:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
      ports:
      - protocol: TCP
        port: 80
      - protocol: TCP
        port: 443
