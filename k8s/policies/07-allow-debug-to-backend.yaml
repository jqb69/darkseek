---
# k8s/07-allow-debug-to-backend.yaml.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-debug-to-backend
  namespace: default
spec:
  # This policy applies to all pods with no labels (including debug-mqtt).
  podSelector:
    matchLabels:
      app: debug-mqtt  # ‚Üê TARGET YOUR SPY
  policyTypes:
    - Egress
  egress:
    # RULE 1 (FIX): Allow DNS resolution to the kube-system namespace on port 53 (UDP/TCP).
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system # Target the kube-system namespace
        podSelector:
          matchLabels:
            k8s-app: kube-dns # Target the DNS pods (e.g., CoreDNS)
      ports:
      - protocol: UDP
        port: 53
      - protocol: TCP # Required for large DNS responses
        port: 53
        
    # RULE 2: Allow communication to the darkseek-backend-ws pods on port 8000 (HTTP/WS)
    - to:
      - podSelector:
          matchLabels:
            app: darkseek-backend-ws
      ports:
      - protocol: TCP
        port: 8000
        
    # RULE 3: Allow communication to the darkseek-backend-mqtt pods on port 1883 (MQTT)
    - to:
      - podSelector:
          matchLabels:
            app: darkseek-backend-mqtt
      ports:
      - protocol: TCP
        port: 1883
