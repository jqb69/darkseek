---
# Deploy to GKE Without DNS
# deploy-to-gke-no-dns.yaml
name: Deploy to GKE Without DNS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    environment: .darkseek_env
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate workflow syntax
        uses: frenck/action-yamllint@v1
        with:
          path: .github/workflows/deploy-to-gke-no-dns.yml

      - name: Check required secrets
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GKE_CLUSTER_ZONE: ${{ secrets.GKE_CLUSTER_ZONE }}
          GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
        run: |
          if [ -z "$GCP_SA_KEY" ]; then
            echo "Error: GCP_SA_KEY is not set"
            exit 1
          fi
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "Error: GCP_PROJECT_ID is not set"
            exit 1
          fi
          if [ -z "$GKE_CLUSTER_ZONE" ]; then
            echo "Error: GKE_CLUSTER_ZONE is not set"
            exit 1
          fi
          if [ -z "$GKE_CLUSTER_NAME" ]; then
            echo "Error: GKE_CLUSTER_NAME is not set"
            exit 1
          fi
          echo "GKE_CLUSTER_ZONE: $GKE_CLUSTER_ZONE"
        shell: bash

      - name: Sanitize GCP Project ID
        id: sanitize
        run: |
          LOWER=$(echo "${{ secrets.GCP_PROJECT_ID }}" | tr '[:upper:]' '[:lower:]')
          echo "GCP_PROJECT_ID_LOWERCASE=$LOWER" >> $GITHUB_ENV
          echo "Sanitized project ID: $LOWER"
        shell: bash

      - name: Validate sanitized project ID
        run: |
          if [[ "${{ env.GCP_PROJECT_ID_LOWERCASE }}" =~ [A-Z] ]]; then
            echo "ERROR: Project ID still contains uppercase after sanitizing!"
            exit 1
          fi
          echo "Project ID is clean: ${{ env.GCP_PROJECT_ID_LOWERCASE }}"
        shell: bash

      - name: Debug frontend directory
        run: |
          echo "Listing app/frontend/ contents:"
          ls -la app/frontend/
          echo "Listing app/frontend/static/ contents:"
          ls -la app/frontend/static/ || echo "Error: app/frontend/static/ not found"
          echo "Listing app/frontend/components/ contents:"
          ls -la app/frontend/components/
        shell: bash

      - name: Debug k8s directory
        run: |
          echo "Current directory: $(pwd)"
          ls -la .
          ls -la k8s/
          if [ -f "./k8s/rollback_k8s.sh" ]; then
            echo "rollback_k8s.sh found"
            chmod +x ./k8s/rollback_k8s.sh
          else
            echo "Error: rollback_k8s.sh not found in k8s/"
            exit 1
          fi
        shell: bash

      - name: Log in to Docker Hub
        run: |
          echo "Logging in to Docker Hub..."
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" \
            --password-stdin
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        shell: bash

      - name: Pre-pull BuildKit with retries
        run: |
          for i in 1 2 3; do
            if docker pull moby/buildkit:buildx-stable-1; then
              echo "Successfully pulled BuildKit image"
              break
            fi
            echo "Retry $i/3 failed, waiting..."
            sleep $((i * 10))
            if [ $i -eq 3 ]; then
              echo "Error: Failed to pull BuildKit after 3 retries"
              exit 1
            fi
          done
        shell: bash

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run tests
        run: |
          echo "Running tests..."
          if [ -d "tests" ]; then
            pytest tests/ || { echo "Tests failed, aborting deployment"; exit 1; }
          else
            echo "No tests directory found, skipping tests"
          fi
        shell: bash

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID_LOWERCASE }}

      - name: Configure Docker for Artifact Registry
        run: |
          echo "Authenticating Docker to us-central1-docker.pkg.dev..."
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Verify service account
        run: |
          if [ -z "$GOOGLE_GHA_CREDS_PATH" ]; then
            echo "Error: GOOGLE_GHA_CREDS_PATH is not set"
            exit 1
          fi
          if [ ! -f "$GOOGLE_GHA_CREDS_PATH" ]; then
            echo "Error: Credentials file not found"
            exit 1
          fi
          SERVICE_ACCOUNT=$(jq -r '.client_email' "$GOOGLE_GHA_CREDS_PATH")
          echo "Service Account: $SERVICE_ACCOUNT"
        shell: bash

      - name: Configure Docker for GCR
        run: |
          echo "Configuring Docker for GCR..."
          gcloud auth configure-docker gcr.io --quiet
        shell: bash

      - name: List all clusters
        id: list-clusters
        run: |
          gcloud container clusters list \
            --project="${{ secrets.GCP_PROJECT_ID }}"
        shell: bash

      - name: Verify GKE cluster location
        run: |
          echo "GKE_CLUSTER_ZONE: ${{ secrets.GKE_CLUSTER_ZONE }}"
          echo "Running as: $(gcloud auth list \
            --filter=status:ACTIVE --format='value(account)')"
          echo "Project: $(gcloud config get-value project)"
          gcloud container clusters list \
            --region="${{ secrets.GKE_CLUSTER_ZONE }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}"
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GKE_CLUSTER_ZONE: ${{ secrets.GKE_CLUSTER_ZONE }}
          GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
        shell: bash

      - name: Install kubectl and gke-gcloud-auth-plugin
        run: |
          echo "Checking for existing kubectl..."
          if ! command -v kubectl &> /dev/null; then
            echo "kubectl not found, installing..."
            KUBECTL_URL="storage.googleapis.com/kubernetes-release/release/$(curl -s \
              storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
            echo "Downloading kubectl..."
            if curl -fLO "$KUBECTL_URL"; then
              chmod +x ./kubectl
              sudo mv ./kubectl /usr/local/bin/kubectl
              echo "kubectl installed successfully"
            else
              echo "Error: Failed to download kubectl"
              exit 1
            fi
          else
            echo "kubectl is already installed"
          fi
          echo "Installing gke-gcloud-auth-plugin..."
          if gcloud components install gke-gcloud-auth-plugin --quiet; then
            echo "gke-gcloud-auth-plugin installed"
          else
            echo "Error: Failed to install gke-gcloud-auth-plugin"
            exit 1
          fi
          echo "Checking gke-gcloud-auth-plugin version..."
          gke-gcloud-auth-plugin --version
        shell: bash

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials \
            "${{ secrets.GKE_CLUSTER_NAME }}" \
            --region="${{ secrets.GKE_CLUSTER_ZONE }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}"
        shell: bash

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./app/frontend
          file: ./app/frontend/Dockerfile
          push: true
          tags: us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID_LOWERCASE }}/darkseek/darkseek-frontend:latest

      - name: Build and push backend-ws
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./app/backend/Dockerfile.ws
          push: true
          tags: us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID_LOWERCASE }}/darkseek/darkseek-backend-ws:latest
          pull: true

      - name: Build and push backend-mqtt
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./app/backend/Dockerfile.mqtt
          push: true
          tags: us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID_LOWERCASE }}/darkseek/darkseek-backend-mqtt:latest
          no-cache: true
          pull: true

      - name: Deploy to GKE
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          HUGGINGFACEHUB_API_TOKEN: ${{ secrets.HUGGINGFACEHUB_API_TOKEN }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          MQTT_BROKER_HOST: ${{ secrets.MQTT_BROKER_HOST }}
          MQTT_BROKER_PORT: ${{ secrets.MQTT_BROKER_PORT }}
          MQTT_TLS: ${{ secrets.MQTT_TLS }}
          MQTT_USERNAME: ${{ secrets.MQTT_USERNAME }}
          MQTT_PASSWORD: ${{ secrets.MQTT_PASSWORD }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID_LOWERCASE }}
        run: |
          echo "Deploying to GKE..."
          chmod +x ./k8s/deploy_k8s.sh
          ./k8s/deploy_k8s.sh || exit 1
        shell: bash

      - name: Verify deployment
        run: |
          kubectl get deployments -n default
          kubectl get pods -n default
          kubectl logs -n default -l app=darkseek-frontend --tail=50
          kubectl logs -n default -l app=darkseek-backend-ws --tail=100
          echo "=== backend-ws pod describe ==="
          kubectl describe pod -n default -l app=darkseek-backend-ws || true
          kubectl logs -n default -l app=darkseek-backend-mqtt --tail=100
          echo "=== backend-mqtt pod describe ==="
          kubectl describe pod -n default -l app=darkseek-backend-mqtt || true
        shell: bash

      - name: Rollback deployment
        if: failure()
        run: |
          echo "Rolling back to previous version..."
          if [ -f "./k8s/rollback_k8s.sh" ]; then
            chmod +x ./k8s/rollback_k8s.sh
            ./k8s/rollback_k8s.sh || { echo "Rollback failed"; exit 1; }
          else
            echo "Error: rollback_k8s.sh not found"
            exit 1
          fi
        shell: bash

      - name: Deploy Permanent MQTT Debugger Pod
        run: |
          echo "Deploying MQTT debugger pod using GCP_PROJECT_ID=${GCP_PROJECT_ID}"
          chmod +x ./k8s/mqtt-debugk8s.sh
          ./k8s/mqtt-debugk8s.sh || echo "MQTT debugger already exists or minor issue -continuing"
        shell: bash
        env:
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID_LOWERCASE }}

      - name: Test MQTT Spy Connectivity (90s max)
        if: success()
        run: |
          chmod +x ./k8s/mqtt-testk8s.sh
          timeout 95 ./k8s/mqtt-testk8s.sh || {
            echo "MQTT TEST FAILED — dumping debug pod logs..."
            kubectl logs debug-mqtt --tail=100 || true
            kubectl describe pod debug-mqtt || true
            exit 1
          }
        shell: bash
        env:
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID_LOWERCASE }}

      - name: Execute Frontend Diagnostic Blitz
        if: success()
        run: |
          chmod +x ./k8s/frontend-testk8s.sh
          ./k8s/frontend-testk8s.sh
        shell: bash

      - name: Victory Message
        if: success()
        run: |
          echo "DARKSEEK RULES B*TCHES!"
          FR_IP="$(kubectl get svc darkseek-frontend -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
          echo "Frontend → http://$FR_IP:8501"
        shell: bash
